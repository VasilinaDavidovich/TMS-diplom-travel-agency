{% extends 'base.html' %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h1 style="color: rgba(255, 255, 255, 0.7)">üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h1>
            <p style="color: rgba(255, 255, 255, 0.6)" id="searchSummary">–ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã...</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <h5 style="color: rgba(255, 255, 255, 0.7)">–£—Ç–æ—á–Ω–∏—Ç–µ –ø–æ–∏—Å–∫</h5>
                    <form id="searchForm" method="get" action="/search/">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label" style="color: rgba(255, 255, 255, 0.7)">–°—Ç—Ä–∞–Ω–∞</label>
                                <select class="form-select" id="countrySelect" name="country">
                                    <option value="">–í—Å–µ —Å—Ç—Ä–∞–Ω—ã</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label" style="color: rgba(255, 255, 255, 0.7)">–ì–æ—Ä–æ–¥</label>
                                <select class="form-select" id="citySelect" name="city" disabled>
                                    <option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label" style="color: rgba(255, 255, 255, 0.7)">–ó–≤—ë–∑–¥—ã</label>
                                <select class="form-select" id="starsSelect" name="stars">
                                    <option value="">–í—Å–µ –∑–≤—ë–∑–¥—ã</option>
                                    <option value="1">‚≠ê (1)</option>
                                    <option value="2">‚≠ê‚≠ê (2)</option>
                                    <option value="3">‚≠ê‚≠ê‚≠ê (3)</option>
                                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4)</option>
                                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5)</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label" style="color: rgba(255, 255, 255, 0.7)">–¶–µ–Ω–∞ –æ—Ç (‚Ç¨)</label>
                                <input type="number"
                                       class="form-control"
                                       id="minPrice"
                                       name="min_price"
                                       placeholder="0"
                                       min="0">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label" style="color: rgba(255, 255, 255, 0.7)">–¶–µ–Ω–∞ –¥–æ (‚Ç¨)</label>
                                <input type="number"
                                       class="form-control"
                                       id="maxPrice"
                                       name="max_price"
                                       placeholder="1000"
                                       min="0">
                            </div>
                        </div>

                        <!-- –ë–ª–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –í–ù–£–¢–†–ò —Ñ–æ—Ä–º—ã -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        <h6 class="mb-0" style="color: rgba(255, 255, 255, 0.7)">
                                            üîÑ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –æ—Ç–µ–ª–µ–π
                                        </h6>
                                    </div>
                                    <div class="col-md-8">
                                        <select class="form-select" id="sortSelect" name="sort_by">
                                            <option value="name">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
                                            <option value="price_asc">üí∞ –¶–µ–Ω–∞ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)</option>
                                            <option value="price_desc">üí∞ –¶–µ–Ω–∞ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)</option>
                                            <option value="stars_asc">‚≠ê –ó–≤—ë–∑–¥—ã (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)</option>
                                            <option value="stars_desc">‚≠ê –ó–≤—ë–∑–¥—ã (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)</option>
                                            <option value="rating_desc">üèÜ –†–µ–π—Ç–∏–Ω–≥ (–≤—ã—Å–æ–∫–∏–π —Å–Ω–∞—á–∞–ª–∞)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        üîç –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫
                                    </button>
                                    <a href="/" class="btn btn-outline-secondary">
                                        ‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row" id="hotelsContainer">
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </div>
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    <div class="row mt-4" id="paginationContainer">
        <!-- –ö–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å -->
    </div>
</div>

<script>
    async function loadCountries() {
        try {
            const response = await fetch('/api/countries/');
            const countries = await response.json();
            const countrySelect = document.getElementById('countrySelect');

            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.id;
                option.textContent = country.name;
                countrySelect.appendChild(option);
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω:', error);
        }
    }

    async function loadCities(countryId) {
        const citySelect = document.getElementById('citySelect');

        if (!countryId) {
            citySelect.disabled = true;
            citySelect.innerHTML = '<option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>';
            return;
        }

        try {
            const response = await fetch(`/api/cities/?country=${countryId}`);
            const cities = await response.json();

            citySelect.disabled = false;
            citySelect.innerHTML = '<option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>';

            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city.id;
                option.textContent = city.name;
                citySelect.appendChild(option);
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤:', error);
        }
    }

    function displayHotels(hotels) {
        const container = document.getElementById('hotelsContainer');

        if (hotels.length === 0) {
            container.innerHTML = `
                <div class="col-12 text-center">
                    <div class="card bg-dark text-white">
                        <div class="card-body">
                            <h5>üòî –û—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h5>
                            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
                        </div>
                    </div>
                </div>
            `;
            return;
        }

        container.innerHTML = hotels.map(hotel => `
            <div class="col-md-4 mb-4">
                <div class="card bg-dark text-white hotel-card"
                     style="border: 1px solid #444; height: 480px; display: flex; flex-direction: column;">
                    ${hotel.main_image ?
                        `<img src="${hotel.main_image}"
                              class="card-img-top"
                              alt="${hotel.name}"
                              style="height: 200px; object-fit: cover;">` :
                        `<div class="card-img-top d-flex align-items-center justify-content-center"
                              style="height: 200px; background: #2d2d2d;">
                            <span>üè® –ù–µ—Ç —Ñ–æ—Ç–æ</span>
                         </div>`
                    }

                    <div class="card-body d-flex flex-column" style="flex: 1;">
                        <h5 class="card-title"
                            style="height: 48px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; color: rgba(255, 255, 255, 0.8)">
                            ${hotel.name}
                        </h5>
                        <p class="card-text" style="color: rgba(255, 255, 255, 0.6)">
                            <small style="color: rgba(255, 255, 255, 0.5) !important">
                                üìç ${hotel.city_name}, ${hotel.country_name}
                            </small>
                        </p>

                        <div class="mb-2">
                            <div class="mb-1">
                                <span class="text-warning">
                                    ${'‚≠ê'.repeat(hotel.stars)}
                                </span>
                            </div>
                            <small style="color: rgba(255, 255, 255, 0.7) !important">
                                –†–µ–π—Ç–∏–Ω–≥ –ø–æ –æ—Ç–∑—ã–≤–∞–º:
                                <strong class="text-warning">
                                    ${hotel.average_rating > 0 ? hotel.average_rating.toFixed(1) : '-'}
                                </strong>
                            </small>
                            <br>
                            <small style="color: rgba(255, 255, 255, 0.5) !important">
                                (${hotel.review_count} –æ—Ç–∑—ã–≤–æ–≤)
                            </small>
                        </div>

                        <div class="mt-auto">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong class="text-warning">
                                    ${hotel.price_per_night}‚Ç¨ / –Ω–æ—á—å
                                </strong>
                                <a href="/hotel/${hotel.id}/" class="btn btn-primary btn-sm">
                                    –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π —Ñ–æ—Ä–º—ã –∏–∑ URL
    function setFormValuesFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);

        const countrySelect = document.getElementById('countrySelect');
        const citySelect = document.getElementById('citySelect');
        const starsSelect = document.getElementById('starsSelect');
        const minPrice = document.getElementById('minPrice');
        const maxPrice = document.getElementById('maxPrice');
        const sortSelect = document.getElementById('sortSelect');

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ URL
        if (urlParams.get('country')) {
            countrySelect.value = urlParams.get('country');
            loadCities(urlParams.get('country')).then(() => {
                if (urlParams.get('city')) {
                    citySelect.value = urlParams.get('city');
                }
            });
        }

        // –ï–°–õ–ò –ï–°–¢–¨ –ü–û–ò–°–ö–û–í–´–ô –ó–ê–ü–†–û–° - –ù–ê–ô–î–ï–ú –ì–û–†–û–î –ò –°–¢–†–ê–ù–£
        const search = urlParams.get('search');
        if (search) {
            // –ù–∞–π–¥–µ–º –≥–æ—Ä–æ–¥ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ —É—Å—Ç–∞–Ω–æ–≤–∏–º —Ñ–∏–ª—å—Ç—Ä—ã
            fetch('/api/cities/')
                .then(response => response.json())
                .then(cities => {
                    const city = cities.find(c => c.name === search);
                    if (city) {
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω—É –∏ –≥–æ—Ä–æ–¥
                        countrySelect.value = city.country;
                        loadCities(city.country).then(() => {
                            citySelect.value = city.id;
                        });
                    }
                });
        }

        if (urlParams.get('stars')) {
            starsSelect.value = urlParams.get('stars');
        }

        if (urlParams.get('min_price')) {
            minPrice.value = urlParams.get('min_price');
        }

        if (urlParams.get('max_price')) {
            maxPrice.value = urlParams.get('max_price');
        }

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º sort_by –∏–∑ ordering –∏–ª–∏ sort_by
        const ordering = urlParams.get('ordering');
        const sortBy = urlParams.get('sort_by');
        
        if (ordering) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º ordering –æ–±—Ä–∞—Ç–Ω–æ –≤ sort_by –¥–ª—è —Ñ–æ—Ä–º—ã
            const orderingToSortBy = {
                'price_per_night': 'price_asc',
                '-price_per_night': 'price_desc',
                'stars': 'stars_asc',
                '-stars': 'stars_desc'
            };
            if (orderingToSortBy[ordering]) {
                sortSelect.value = orderingToSortBy[ordering];
            }
        } else if (sortBy) {
            sortSelect.value = sortBy;
        }
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ
let paginationData = null;

// –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–µ–ª–µ–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    async function loadInitialHotels(pageUrl = null) {
        try {
            const queryString = window.location.search.substring(1);
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ —Å—Ç—Ä–æ–∏–º –∏–∑ queryString
            const url = pageUrl || `/api/hotels/?${queryString}`;

            const response = await fetch(url);
            const data = await response.json();

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
            paginationData = {
                count: data.count,
                next: data.next,
                previous: data.previous,
                currentPage: getCurrentPageNumber(url)
            };

            // API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
            const hotels = data.results || data;

            displayHotels(hotels);
            displayPagination(paginationData);

            const summary = document.getElementById('searchSummary');
            if (hotels.length === 0) {
                summary.textContent = 'üòî –û—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞.';
            } else {
                const startItem = (paginationData.currentPage - 1) * 9 + 1;
                const endItem = Math.min(startItem + hotels.length - 1, paginationData.count);
                summary.textContent = `–ù–∞–π–¥–µ–Ω–æ –æ—Ç–µ–ª–µ–π: ${paginationData.count} (–ø–æ–∫–∞–∑–∞–Ω–æ ${startItem}-${endItem})`;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–µ–ª–µ–π:', error);
        }
    }

    // –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ URL
    function getCurrentPageNumber(url) {
        const urlParams = new URLSearchParams(url.split('?')[1] || '');
        return parseInt(urlParams.get('page') || '1');
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    function displayPagination(pagination) {
        const container = document.getElementById('paginationContainer');

        if (!pagination || pagination.count <= 9) {
            // –ï—Å–ª–∏ –æ—Ç–µ–ª–µ–π –º–µ–Ω—å—à–µ 10, –ø–∞–≥–∏–Ω–∞—Ü–∏—è –Ω–µ –Ω—É–∂–Ω–∞
            container.innerHTML = '';
            return;
        }

        const totalPages = Math.ceil(pagination.count / 9);
        const currentPage = pagination.currentPage || 1;

        let paginationHTML = '<div class="col-12"><nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º">';
        paginationHTML += '<ul class="pagination justify-content-center">';

        // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–µ–¥—ã–¥—É—â–∞—è"
        if (pagination.previous) {
            paginationHTML += `<li class="page-item">
                <a class="page-link" href="#" onclick="loadPage('${pagination.previous}'); return false;">
                    ‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                </a>
            </li>`;
        } else {
            paginationHTML += `<li class="page-item disabled">
                <span class="page-link">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</span>
            </li>`;
        }

        // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –∏ —Å–æ—Å–µ–¥–Ω–∏–µ)
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);

        if (startPage > 1) {
            paginationHTML += `<li class="page-item">
                <a class="page-link" href="#" onclick="loadPage(null, 1); return false;">1</a>
            </li>`;
            if (startPage > 2) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            if (i === currentPage) {
                paginationHTML += `<li class="page-item active">
                    <span class="page-link">${i}</span>
                </li>`;
            } else {
                paginationHTML += `<li class="page-item">
                    <a class="page-link" href="#" onclick="loadPage(null, ${i}); return false;">${i}</a>
                </li>`;
            }
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            paginationHTML += `<li class="page-item">
                <a class="page-link" href="#" onclick="loadPage(null, ${totalPages}); return false;">${totalPages}</a>
            </li>`;
        }

        // –ö–Ω–æ–ø–∫–∞ "–°–ª–µ–¥—É—é—â–∞—è"
        if (pagination.next) {
            paginationHTML += `<li class="page-item">
                <a class="page-link" href="#" onclick="loadPage('${pagination.next}'); return false;">
                    –°–ª–µ–¥—É—é—â–∞—è ‚Üí
                </a>
            </li>`;
        } else {
            paginationHTML += `<li class="page-item disabled">
                <span class="page-link">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</span>
            </li>`;
        }

        paginationHTML += '</ul></nav></div>';
        container.innerHTML = paginationHTML;
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function loadPage(pageUrl, pageNumber = null) {
        if (pageNumber) {
            // –°—Ç—Ä–æ–∏–º URL —Å –Ω–æ–º–µ—Ä–æ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('page', pageNumber);
            const queryString = urlParams.toString();
            loadInitialHotels(`/api/hotels/?${queryString}`);
        } else if (pageUrl) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤—ã–π URL –∏–∑ API
            loadInitialHotels(pageUrl);
        }

        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π
        document.getElementById('countrySelect').addEventListener('change', function() {
            const countryId = this.value;
            loadCities(countryId);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ –Ω–∞—à –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        document.getElementById('sortSelect').addEventListener('change', function() {
            document.getElementById('searchForm').dispatchEvent(new Event('submit'));
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ –Ω–æ–≤–æ–º –ø–æ–∏—Å–∫–µ
    document.getElementById('searchForm').addEventListener('submit', function(e) {
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
        e.preventDefault();

        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
        const formData = new FormData(this);
        const urlParams = new URLSearchParams();

        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º sort_by –≤ ordering –¥–ª—è DRF OrderingFilter
        const sortBy = formData.get('sort_by');
        const sortByToOrdering = {
            'price_asc': 'price_per_night',
            'price_desc': '-price_per_night',
            'stars_asc': 'stars',
            'stars_desc': '-stars',
            'rating_desc': 'rating_desc'  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –≤ views.py
        };

        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã –≤ URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        for (const [key, value] of formData.entries()) {
            if (value) {  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                if (key === 'sort_by') {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º sort_by –≤ ordering (–∫—Ä–æ–º–µ rating_desc)
                    if (sortBy && sortBy !== 'name' && sortBy !== 'rating_desc') {
                        urlParams.append('ordering', sortByToOrdering[value]);
                    } else if (sortBy === 'rating_desc') {
                        // rating_desc –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ sort_by –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
                        urlParams.append('sort_by', 'rating_desc');
                    }
                } else {
                    urlParams.append(key, value);
                }
            }
        }

        // –£–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä page –ø—Ä–∏ –Ω–æ–≤–æ–º –ø–æ–∏—Å–∫–µ
        urlParams.delete('page');

        // –û–±–Ω–æ–≤–ª—è–µ–º URL —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        const newUrl = '/search/?' + urlParams.toString();
        window.history.pushState({}, '', newUrl);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –∏–∑ URL (—á—Ç–æ–±—ã –æ–Ω–∏ –æ—Ç–æ–±—Ä–∞–∑–∏–ª–∏—Å—å)
        setFormValuesFromUrl();

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–µ–ª–∏ —Å –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –Ω–æ–≤—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
        loadInitialHotels();
    });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        loadCountries().then(() => {
            setFormValuesFromUrl();
            loadInitialHotels();
        });
    });
</script>
{% endblock %}