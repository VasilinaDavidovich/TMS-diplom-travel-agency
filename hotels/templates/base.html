<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Travel - –ö–æ—Å–º–∏—á–µ—Å–∫–∏–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.8)),
                        url('https://unsplash.com/photos/hF27It_F5xY/download?ixid=M3wxMjA3fDB8MXxzZWFyY2h8MjkwfHxzdGFyc3xlbnwwfHx8fDE3NjIzNzEzMDl8MA&force=true');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: rgba(255, 255, 255, 0.9);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background-color: rgba(15, 25, 45, 0.9) !important;
            backdrop-filter: blur(10px);
        }

        footer {
            background-color: rgba(15, 25, 45, 0.9);
            padding: 20px 0;
            margin-top: auto;
        }

        main {
            flex: 1;
        }

        .card {
            background-color: rgba(15, 25, 45, 0.8) !important;
            backdrop-filter: blur(5px);
            border: 1px solid #2a3f5f;
        }

        .form-control,
        .form-select {
            background-color: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .form-control:focus,
        .form-select:focus {
            background-color: rgba(255, 255, 255, 0.15) !important;
            border-color: #4d7cfe;
            color: white;
            box-shadow: 0 0 0 0.2rem rgba(77, 124, 254, 0.25);
        }

        .form-label {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .form-select option {
            background-color: #1a1a2e;
            color: white;
        }

        .form-select:focus option {
            background-color: #2a3f5f;
            color: white;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                üöÄ Star Travel
            </a>

            <!-- –ü–æ–∏—Å–∫–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ -->
            <div class="d-flex me-3" style="width: 300px;">
                <input type="text"
                       class="form-control"
                       id="headerSearch"
                       placeholder="–ü–æ–∏—Å–∫ –æ—Ç–µ–ª–µ–π, –≥–æ—Ä–æ–¥–æ–≤..."
                       style="background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white;">
            </div>

            <div class="navbar-nav">
                <a class="nav-link" href="/">–ì–ª–∞–≤–Ω–∞—è</a>
                <a class="nav-link" href="/search/">–û—Ç–µ–ª–∏</a>
                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">–í–æ–π—Ç–∏</a>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        {% block content %}
        {% endblock %}
    </main>

    <footer>
        <div class="container text-center">
            <p class="mb-0">‚ú® &copy; 2025 Star Travel. –û—Ç–∫—Ä–æ–π –Ω–æ–≤—ã–µ –º–∏—Ä—ã! ‚ú®</p>
        </div>
    </footer>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-0">
                    <h5 class="modal-title">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –≤–∏–¥–∏–º–∞) -->
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">–í–æ–π—Ç–∏</button>
                        <div class="text-center mt-3">
                            <small>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" id="showRegister">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></small>
                        </div>
                    </form>

                    <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞) -->
                    <form id="registerForm" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                            <input type="password" class="form-control" name="password2" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                        <div class="text-center mt-3">
                            <small>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" id="showLogin">–í–æ–π—Ç–∏</a></small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        async function safeFetch(url, options = {}) {
            try {
                const response = await fetch(url, options);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º Content-Type –æ—Ç–≤–µ—Ç–∞
                const contentType = response.headers.get('content-type');

                if (!contentType || !contentType.includes('application/json')) {
                    // –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, –Ω–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                    console.warn('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON –æ—Ç–≤–µ—Ç –¥–ª—è URL:', url);

                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é - –æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    if (response.status >= 500) {
                        throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                    } else {
                        throw new Error('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.');
                    }
                }

                const result = await response.json();
                return { success: true, response, data: result };
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ fetch –¥–ª—è URL:', url, error);

                // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                let userMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.';
                if (error.message.includes('—Å–µ—Ä–≤–µ—Ä') || error.message.includes('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞')) {
                    userMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
                }

                return {
                    success: false,
                    error: userMessage
                };
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            checkAuthStatus();

            const headerSearch = document.getElementById('headerSearch');

            if (headerSearch) {
                headerSearch.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const searchTerm = this.value.trim();
                        if (searchTerm) {
                            window.location.href = `/search/?search=${encodeURIComponent(searchTerm)}`;
                        }
                    }
                });
            }

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ñ–æ—Ä–º–∞–º–∏ –≤—Ö–æ–¥–∞ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const showRegister = document.getElementById('showRegister');
            const showLogin = document.getElementById('showLogin');

            if (showRegister) {
                showRegister.addEventListener('click', function(e) {
                    e.preventDefault();
                    loginForm.style.display = 'none';
                    registerForm.style.display = 'block';
                });
            }

            if (showLogin) {
                showLogin.addEventListener('click', function(e) {
                    e.preventDefault();
                    registerForm.style.display = 'none';
                    loginForm.style.display = 'block';
                });
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            if (registerForm) {
                registerForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    console.log('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');

                    const formData = new FormData(this);
                    const data = {
                        username: formData.get('username'),
                        email: formData.get('email'),
                        password: formData.get('password'),
                        password2: formData.get('password2')
                    };

                    console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:', data);

                    const result = await safeFetch('/api/auth/register/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    if (result.success) {
                        if (result.response.ok) {
                            alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.');
                            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
                            registerForm.style.display = 'none';
                            loginForm.style.display = 'block';
                            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                            registerForm.reset();
                        } else {
                            // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
                            if (result.data.username) {
                                alert('‚ùå –û—à–∏–±–∫–∞: ' + result.data.username[0]);
                            } else if (result.data.email) {
                                alert('‚ùå –û—à–∏–±–∫–∞: ' + result.data.email[0]);
                            } else if (result.data.password) {
                                alert('‚ùå –û—à–∏–±–∫–∞: ' + result.data.password[0]);
                            } else if (result.data.non_field_errors) {
                                alert('‚ùå –û—à–∏–±–∫–∞: ' + result.data.non_field_errors[0]);
                            } else {
                                alert('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.');
                            }
                        }
                    } else {
                        alert('‚ùå ' + result.error);
                    }
                });
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    console.log('–í—Ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');

                    const formData = new FormData(this);
                    const data = {
                        username: formData.get('username'),
                        password: formData.get('password')
                    };

                    console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞:', data);

                    const result = await safeFetch('/api/auth/login/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    if (result.success) {
                        if (result.response.ok) {
                            alert('‚úÖ –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!');
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ localStorage
                            localStorage.setItem('access_token', result.data.access);
                            localStorage.setItem('refresh_token', result.data.refresh);
                            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                            const modal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                            modal.hide();
                            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                            updateAuthUI();
                        } else {
                            if (result.data.error) {
                                alert('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + result.data.error);
                            } else {
                                alert('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ.');
                            }
                        }
                    } else {
                        alert('‚ùå ' + result.error);
                    }
                });
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
        function updateAuthUI() {
            const loginButton = document.querySelector('a[data-bs-target="#loginModal"]');
            if (loginButton && localStorage.getItem('access_token')) {
                // –ú–µ–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å
                loginButton.textContent = '–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å';
                loginButton.href = '/api/auth/profile/';
                loginButton.removeAttribute('data-bs-toggle');
                loginButton.removeAttribute('data-bs-target');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function checkAuthStatus() {
            const token = localStorage.getItem('access_token');
            if (token) {
                updateAuthUI();
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>